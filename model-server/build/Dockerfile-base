FROM amazonlinux:2 as base-stage

ENV PYTHONUNBUFFERED=TRUE
ENV PYTHONDONTWRITEBYTECODE=TRUE

# neuron sdk, pytorch setup
#  https://awsdocs-neuron.readthedocs-hosted.com/en/latest/neuron-intro/pytorch-setup/pytorch-install.html

# Configure Linux for Neuron repository updates
ADD ./build/add-neuron-repo.sh /tmp/add-neuron-repo.sh
RUN chmod +x /tmp/add-neuron-repo.sh && sh /tmp/add-neuron-repo.sh

RUN rpm --import https://yum.repos.neuron.amazonaws.com/GPG-PUB-KEY-AMAZON-AWS-NEURON.PUB

RUN yum update -y

# Install OS headers, Neuron Driver, Neuron Tools
RUN yum install kernel-devel-$(uname -r) kernel-headers-$(uname -r) \
                aws-neuron-dkms aws-neuron-tools \
                -y

ENV PATH=/opt/aws/neuron/bin:$PATH

RUN yum install -y python3.7 python3.7-devel gcc-c++ \
                   tar gzip ca-certificates procps net-tools which vim wget libgomp htop jq bind-utils bc

#Install Neuron PyTorch
RUN pip3 install torch-neuron neuron-cc[tensorflow] torchvision --extra-index-url=https://pip.repos.neuron.amazonaws.com

RUN pip3 install transformers fugashi ipadic

# For Trace ---------------------------------------
FROM inf1-base as trace-stage

ENV AWS_NEURON_VISIBLE_DEVICES=ALL

RUN mkdir -p /app/trace

ADD ./trace/tracer.py /app/trace

WORKDIR /app/trace/

RUN python3.7 tracer.py

# For Model Server --------------------------------
FROM inf1-base as model-stage

COPY ./app/requirements.txt /app/server/requirements.txt
RUN pip3 install -r /app/server/requirements.txt

RUN mkdir -p /app/server/models
COPY --from=trace-stage /app/trace/ /app/server/models

COPY ./app/run.sh /app/server/run.sh
COPY ./app/main.py /app/server/main.py

WORKDIR /app/server

EXPOSE 8080

CMD ["./run.sh"]